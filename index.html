<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macca Flow Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --biru-dalam: #040a16;
            --ungu-elektrik: #8a2be2;
            --pink-krimson: #ff007f;
            --emas-murni: #efbf3b;
            --kaca-bg: rgba(255, 255, 255, 0.05);
            --kaca-garis: rgba(255, 255, 255, 0.1);
            --cahaya-neon: 0 0 20px rgba(138, 43, 226, 0.3);
            --sukses: #00ff88;
            --bahaya: #ff3366;
            --teks-utama: #f8f9fa;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #040a16 100%);
            color: var(--teks-utama); min-height: 100vh;
            overflow-x: hidden;
        }

        .wadah { padding: 25px; max-width: 480px; margin: auto; padding-bottom: 130px; }
        .halaman { display: none; animation: geserAtas 0.4s ease-out; }
        .halaman.aktif { display: block; }

        header { text-align: center; padding: 20px 0; }
        h1 { 
            font-size: 1.6rem; font-weight: 600; letter-spacing: 3px; 
            background: linear-gradient(to right, var(--emas-murni), var(--pink-krimson));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0;
        }

        /* --- [SECTION: DASHBOARD CARD] --- */
        .kartu-saldo {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            backdrop-filter: blur(15px); border: 1px solid var(--kaca-garis);
            border-radius: 25px; padding: 35px 25px; text-align: center;
            box-shadow: var(--cahaya-neon); margin-bottom: 30px;
        }
        .jumlah-saldo { font-size: 2.1rem; font-weight: 600; color: #fff; }

        /* --- [SECTION: PROTECTED RIWAYAT UI] --- */
        .item-riwayat-elite {
            background: linear-gradient(135deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02));
            backdrop-filter: blur(10px); border: 1px solid var(--kaca-garis);
            border-radius: 20px; padding: 18px; margin-bottom: 15px;
            display: flex; align-items: center; gap: 15px;
        }
        .icon-riwayat { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .riwayat-info { flex: 1; }
        .riwayat-kat { font-size: 0.85rem; font-weight: 600; color: var(--teks-utama); display: block; }
        .riwayat-jam { font-size: 0.65rem; color: var(--emas-murni); opacity: 0.8; }
        .riwayat-nominal { text-align: right; }
        .riwayat-amt { font-size: 0.95rem; font-weight: 600; display: block; }
        .riwayat-desc { font-size: 0.7rem; opacity: 0.5; font-style: italic; }

        /* --- [SECTION: PROTECTED NERACA UI] --- */
        .kartu-neraca {
            background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
            backdrop-filter: blur(15px); border: 1px solid var(--kaca-garis);
            border-radius: 25px; padding: 25px; margin-bottom: 20px;
            box-shadow: var(--cahaya-neon);
        }
        .neraca-header { font-size: 0.65rem; color: var(--emas-murni); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 15px; display: block; }
        .neraca-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .neraca-item { display: flex; align-items: center; gap: 12px; }
        .neraca-item i { width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .bg-in { background: rgba(0, 255, 136, 0.1); color: var(--sukses); }
        .bg-out { background: rgba(255, 51, 102, 0.1); color: var(--bahaya); }
        .bg-net { background: rgba(239, 191, 59, 0.1); color: var(--emas-murni); }
        .value-neraca { font-size: 1rem; font-weight: 600; }
        .total-box { border-top: 1px solid var(--kaca-garis); padding-top: 15px; margin-top: 5px; }

        /* --- [SECTION: GENERAL UI ELEMENTS] --- */
        h2 { font-size: 0.8rem; color: var(--emas-murni); letter-spacing: 1.5px; text-transform: uppercase; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; }
        h2::after { content: ""; flex: 1; height: 1px; background: linear-gradient(to right, var(--kaca-garis), transparent); }
        input, select, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--kaca-garis); color: #fff; padding: 14px; border-radius: 15px; font-family: 'Poppins'; outline: none; box-sizing: border-box; margin-bottom: 15px; }
        .grid-tombol { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tombol-aksi { background: var(--kaca-bg); border: 1px solid var(--kaca-garis); border-radius: 20px; padding: 18px 10px; color: white; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .tombol-aksi i { font-size: 1.4rem; background: linear-gradient(45deg, var(--emas-murni), var(--pink-krimson)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-bawah { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px; border-radius: 20px; border: 1px solid var(--kaca-garis); z-index: 1000; }
        .nav-item { color: rgba(255,255,255,0.4); cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.aktif { color: var(--emas-murni); }
        .nav-item span { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }

        /* --- [SECTION: MODAL & SUB-CATEGORY] --- */
        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(15px); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-konten { background: linear-gradient(160deg, #0f172a 0%, #040a16 100%); border: 1px solid var(--kaca-garis); border-radius: 30px; padding: 30px; width: 100%; max-width: 380px; }
        #labelTipeModal { display: inline-block; padding: 4px 12px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; letter-spacing: 1.5px; margin-bottom: 10px; text-transform: uppercase; }
        .label-masuk { background: rgba(0, 255, 136, 0.15); color: var(--sukses); border: 1px solid var(--sukses); }
        .label-keluar { background: rgba(255, 51, 102, 0.15); color: var(--bahaya); border: 1px solid var(--bahaya); }
        
        .box-sub { display: none; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 15px; }
        .btn-sub { flex: 1; min-width: 80px; padding: 8px; border-radius: 10px; border: 1px solid var(--kaca-garis); background: transparent; color: white; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
        .btn-sub.aktif { background: var(--emas-murni); color: var(--biru-dalam); border-color: var(--emas-murni); font-weight: 600; }

        @keyframes geserAtas { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="wadah">
        <div id="beranda" class="halaman aktif">
            <header><h1>MACCA FLOW</h1></header>
            <div class="kartu-saldo">
                <small style="color:var(--pink-krimson); font-weight: 600; letter-spacing: 2px;">SALDO TERSEDIA</small>
                <div class="jumlah-saldo" id="saldoUtama">Rp. 0</div>
            </div>
            <h2><i class="fa-solid fa-arrow-down"></i> Kas Masuk</h2>
            <div class="grid-tombol">
                <button class="tombol-aksi" onclick="bukaModal('CASH KASIR', 'masuk')"><i class="fa-solid fa-cash-register"></i><span>Kasir</span></button>
                <button class="tombol-aksi" onclick="bukaModal('CASH GERAI', 'masuk')"><i class="fa-solid fa-store"></i><span>Gerai</span></button>
                <button class="tombol-aksi" onclick="bukaModal('CASH WARKOP', 'masuk')"><i class="fa-solid fa-mug-hot"></i><span>Warkop</span></button>
                <button class="tombol-aksi" onclick="bukaModal('QRIS / TRANSFER', 'masuk')"><i class="fa-solid fa-qrcode"></i><span>QRIS</span></button>
            </div>
            <h2><i class="fa-solid fa-arrow-up"></i> Kas Keluar</h2>
            <div class="grid-tombol">
                <button class="tombol-aksi" onclick="bukaModal('KASIR (ARA)', 'keluar')"><i class="fa-solid fa-user-tie"></i><span>Ara</span></button>
                <button class="tombol-aksi" onclick="bukaModal('DAPUR (ATI)', 'keluar')"><i class="fa-solid fa-kitchen-set"></i><span>Ati</span></button>
                <button class="tombol-aksi" onclick="bukaModal('STOK IKAN', 'keluar')"><i class="fa-solid fa-fish"></i><span>Stok</span></button>
                <button class="tombol-aksi" onclick="bukaModal('PAK BOSS', 'keluar')"><i class="fa-solid fa-crown"></i><span>Boss</span></button>
            </div>
        </div>

        <div id="riwayat" class="halaman">
            <header><h1>RIWAYAT TRANSAKSI</h1></header>
            <input type="date" id="riwayatTgl" onchange="syncUI()">
            <div id="listRiwayat"></div>
        </div>

        <div id="neraca" class="halaman">
            <header><h1>NERACA MACCA</h1></header>
            <h2><i class="fa-solid fa-calendar-day"></i> Harian</h2>
            <input type="date" id="nDaily" onchange="syncUI()">
            <div id="boxHarian" class="kartu-neraca"></div>
            <h2><i class="fa-solid fa-calendar-week"></i> Bulanan</h2>
            <input type="month" id="nMonthly" onchange="syncUI()">
            <div id="boxBulanan" class="kartu-neraca"></div>
            <h2><i class="fa-solid fa-chart-line"></i> Tahunan</h2>
            <select id="nYearly" onchange="syncUI()">
                <option value="2025">Tahun 2025</option>
                <option value="2026" selected>Tahun 2026</option>
            </select>
            <div id="boxTahunan" class="kartu-neraca"></div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-konten">
            <div style="text-align: center; margin-bottom: 15px;">
                <div id="labelTipeModal">TIPE</div>
                <h3 id="judulModal" style="color:white; margin:0; letter-spacing:1px;">KATEGORI</h3>
            </div>
            
            <div id="subCategoryKasir" class="box-sub">
                <button class="btn-sub aktif" onclick="pilihSub(this, 'Penjualan Toko')">Toko</button>
                <button class="btn-sub" onclick="pilihSub(this, 'GrabFood')">Grab</button>
                <button class="btn-sub" onclick="pilihSub(this, 'GoFood')">Gojek</button>
            </div>

            <input type="text" id="inNominal" placeholder="Rp. 0" oninput="formatRupiah(this)">
            <textarea id="inCatatan" rows="2" placeholder="Detail transaksi..."></textarea>
            
            <button onclick="simpanData()" style="width: 100%; padding: 16px; background: linear-gradient(45deg, var(--ungu-elektrik), var(--pink-krimson)); border: none; border-radius: 15px; color: white; font-weight: 600; cursor: pointer;">SIMPAN DATA</button>
            <p onclick="tutupModal()" style="text-align:center; color:rgba(255,255,255,0.4); cursor:pointer; font-size:0.8rem; margin-top:20px;">BATALKAN</p>
        </div>
    </div>

    <nav class="nav-bawah">
        <div class="nav-item aktif" onclick="gantiHal('beranda')"><i class="fa-solid fa-compass"></i><span>Beranda</span></div>
        <div class="nav-item" onclick="gantiHal('riwayat')"><i class="fa-solid fa-receipt"></i><span>Riwayat</span></div>
        <div class="nav-item" onclick="gantiHal('neraca')"><i class="fa-solid fa-scale-balanced"></i><span>Neraca</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAXs5ZVr6gop28qPKbeaqTRiNdEGZlZMZQ", authDomain: "cashflowmacca.firebaseapp.com", projectId: "cashflowmacca", databaseURL: "https://stocklistmacca-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const rtdb = getDatabase(app);
        const colRef = collection(db, "transactions");

        let cache = []; let cKat = "", cTip = "", cSub = "Penjualan Toko";
        const hariIni = new Date().toISOString().split('T')[0];

        document.getElementById('riwayatTgl').value = hariIni;
        document.getElementById('nDaily').value = hariIni;
        document.getElementById('nMonthly').value = hariIni.substring(0, 7);

        window.gantiHal = (id) => {
            document.querySelectorAll('.halaman').forEach(h => h.classList.remove('aktif'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('aktif'));
            document.getElementById(id).classList.add('aktif');
            event.currentTarget.classList.add('aktif');
        };

        window.bukaModal = (k, t) => {
            cKat = k; cTip = t; cSub = "Penjualan Toko";
            const lb = document.getElementById('labelTipeModal');
            const subBox = document.getElementById('subCategoryKasir');
            
            document.getElementById('judulModal').innerText = k;
            lb.innerText = t === 'masuk' ? "KAS MASUK" : "KAS KELUAR";
            lb.className = t === 'masuk' ? "label-masuk" : "label-keluar";
            
            // Tampilkan sub-pilihan hanya untuk CASH KASIR
            subBox.style.display = (k === 'CASH KASIR') ? 'flex' : 'none';
            
            document.getElementById('modal').style.display = 'flex';
        };

        window.pilihSub = (btn, val) => {
            document.querySelectorAll('.btn-sub').forEach(b => b.classList.remove('aktif'));
            btn.classList.add('aktif');
            cSub = val;
        };

        window.tutupModal = () => { document.getElementById('modal').style.display = 'none'; document.getElementById('inNominal').value = ""; };
        window.formatRupiah = (el) => { let v = el.value.replace(/\D/g, ""); el.value = v ? "Rp. " + parseInt(v).toLocaleString('id-ID') : ""; };

        window.simpanData = async () => {
            const nom = parseInt(document.getElementById('inNominal').value.replace(/\D/g, ""));
            if(!nom) return;
            const finalDesc = (cKat === 'CASH KASIR' ? "[" + cSub + "] " : "") + document.getElementById('inCatatan').value;
            tutupModal();
            await addDoc(colRef, { category: cKat, type: cTip==='masuk'?'in':'out', amount: nom, description: finalDesc, timestamp: serverTimestamp() });
        };

        onSnapshot(colRef, (s) => {
            cache = []; let sal = 0;
            s.forEach(d => {
                const x = d.data();
                if(x.timestamp) { cache.push({...x, id: d.id, t: x.timestamp.toDate()}); sal += (x.type === 'in' ? x.amount : -x.amount); }
            });
            document.getElementById('saldoUtama').innerText = "Rp. " + sal.toLocaleString('id-ID');
            syncUI();
        });

        window.syncUI = () => {
            const list = document.getElementById('listRiwayat'); list.innerHTML = "";
            const fR = document.getElementById('riwayatTgl').value;
            const getIcon = (cat) => {
                if(cat.includes("KASIR")) return "fa-cash-register";
                if(cat.includes("GERAI")) return "fa-store";
                if(cat.includes("WARKOP")) return "fa-mug-hot";
                if(cat.includes("QRIS")) return "fa-qrcode";
                if(cat.includes("ARA")) return "fa-user-tie";
                if(cat.includes("ATI")) return "fa-kitchen-set";
                if(cat.includes("STOK")) return "fa-fish";
                if(cat.includes("BOSS")) return "fa-crown";
                return "fa-wallet";
            };

            cache.filter(d => d.t.toISOString().split('T')[0] === fR).sort((a,b) => b.t - a.t).forEach(d => {
                const isInc = d.type === 'in';
                const div = document.createElement('div');
                div.className = 'item-riwayat-elite';
                div.innerHTML = `
                    <div class="icon-riwayat" style="background:${isInc?'rgba(0,255,136,0.1)':'rgba(255,51,102,0.1)'}; color:${isInc?'var(--sukses)':'var(--bahaya)'}"><i class="fa-solid ${getIcon(d.category)}"></i></div>
                    <div class="riwayat-info"><span class="riwayat-kat">${d.category}</span><span class="riwayat-jam">${d.t.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})} WIB</span></div>
                    <div class="riwayat-nominal"><span class="riwayat-amt" style="color:${isInc?'var(--sukses)':'var(--bahaya)'}">${isInc?'+':'-'} Rp ${d.amount.toLocaleString()}</span><span class="riwayat-desc">${d.description || '-'}</span></div>`;
                list.appendChild(div);
            });

            const drawNeraca = (target, data, title) => {
                let pIn = 0, pOut = 0;
                data.forEach(d => { if(d.type==='in') pIn += d.amount; else pOut += d.amount; });
                document.getElementById(target).innerHTML = `
                    <span class="neraca-header">${title}</span>
                    <div class="neraca-row"><div class="neraca-item"><i class="fa-solid fa-arrow-down bg-in"></i><div><div class="label-neraca">Pemasukan</div><div class="value-neraca">Rp ${pIn.toLocaleString()}</div></div></div></div>
                    <div class="neraca-row"><div class="neraca-item"><i class="fa-solid fa-arrow-up bg-out"></i><div><div class="label-neraca">Pengeluaran</div><div class="value-neraca">Rp ${pOut.toLocaleString()}</div></div></div></div>
                    <div class="total-box"><div class="neraca-row" style="margin-bottom:0"><div class="neraca-item"><i class="fa-solid fa-wallet bg-net"></i><div><div class="label-neraca">Laba Bersih</div><div class="value-neraca" style="color:var(--emas-murni); font-size:1.3rem">Rp ${(pIn-pOut).toLocaleString()}</div></div></div></div></div>`;
            };
            drawNeraca("boxHarian", cache.filter(d => d.t.toISOString().split('T')[0] === document.getElementById('nDaily').value), "LAPORAN HARIAN");
            drawNeraca("boxBulanan", cache.filter(d => d.t.toISOString().substring(0, 7) === document.getElementById('nMonthly').value), "LAPORAN BULANAN");
            drawNeraca("boxTahunan", cache.filter(d => d.t.getFullYear().toString() === document.getElementById('nYearly').value), "LAPORAN TAHUNAN");
        };

        onValue(ref(rtdb, 'stok_macca_v14_flow'), async (s) => {
            const d = s.val(); if(!d) return;
            let i = 0, a = 0, c = 0; const start = new Date().setHours(0,0,0,0);
            Object.values(d).forEach(x => { if(x.time >= start && x.note?.includes("Penj. Gerai Depan")) { const sub = x.qty * (x.price || 0); if(x.type.toLowerCase().includes("ikan")) i += sub; else if(x.type.toLowerCase().includes("ungkep")) a += sub; else if(x.type.toLowerCase().includes("crispy")) c += sub; } });
            const tot = i + a + c;
            if(tot > 0) {
                const key = "AUTO-SYNC-" + hariIni;
                const q = query(colRef, where("note", "==", key));
                const snap = await getDocs(q);
                if(snap.empty) await addDoc(colRef, { category: "CASH GERAI", type: "in", amount: tot, note: key, description: `Ikan:Rp${i.toLocaleString()}, Ayam:Rp${a.toLocaleString()}`, timestamp: serverTimestamp() });
                else if(snap.docs[0].data().amount !== tot) await updateDoc(doc(db, "transactions", snap.docs[0].id), { amount: tot });
            }
        });
    </script>
</body>
</html>