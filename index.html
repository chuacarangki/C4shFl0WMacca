<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Macca Flow Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --biru-dalam: #040a16;
            --ungu-elektrik: #8a2be2;
            --pink-krimson: #ff007f;
            --emas-murni: #efbf3b;
            --kaca-bg: rgba(255, 255, 255, 0.05);
            --kaca-garis: rgba(255, 255, 255, 0.1);
            --sukses: #00ff88;
            --bahaya: #ff3366;
            --teks-utama: #f8f9fa;
        }

        body { margin: 0; font-family: 'Poppins', sans-serif; background: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #040a16 100%); color: var(--teks-utama); min-height: 100vh; overflow-x: hidden; }
        .wadah { padding: 25px; max-width: 480px; margin: auto; padding-bottom: 130px; }
        .halaman { display: none; }
        .halaman.aktif { display: block; animation: geserAtas 0.4s ease-out; }

        header { text-align: center; padding: 30px 0 20px; }
        .logo-crown { font-size: 1.8rem; color: var(--emas-murni); margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(239, 191, 59, 0.5)); }
        h1 { font-size: 1.4rem; font-weight: 600; letter-spacing: 4px; background: linear-gradient(to right, var(--emas-murni), #fff, var(--emas-murni)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; text-transform: uppercase; }
        .sub-header { font-size: 0.65rem; color: rgba(255,255,255,0.4); letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; display: block; }

        /* Saldo & Grafik */
        .kartu-saldo { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); backdrop-filter: blur(15px); border: 1px solid var(--kaca-garis); border-radius: 25px; padding: 35px 25px; text-align: center; margin-bottom: 30px; }
        .jumlah-saldo { font-size: 2.1rem; font-weight: 600; color: #fff; }
        .kartu-grafik { background: rgba(255,255,255,0.03); border: 1px solid var(--kaca-garis); border-radius: 25px; padding: 15px; margin-bottom: 25px; }
        .chart-legend { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--kaca-garis); }
        .legend-item { font-size: 0.55rem; display: flex; align-items: center; gap: 4px; color: rgba(255,255,255,0.5); }
        .dot { width: 7px; height: 7px; border-radius: 50%; }

        /* Tombol Aksi */
        h2 { font-size: 0.8rem; color: var(--emas-murni); letter-spacing: 1.5px; text-transform: uppercase; margin: 25px 0 15px; display: flex; align-items: center; gap: 10px; }
        .grid-tombol { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .tombol-aksi { background: var(--kaca-bg); border: 1px solid var(--kaca-garis); border-radius: 20px; padding: 18px 10px; color: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; transition: 0.2s; }
        .tombol-aksi i { font-size: 1.4rem; color: var(--emas-murni); }

        /* Notifikasi */
        #notif { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--emas-murni); padding: 15px 30px; border-radius: 50px; display: flex; align-items: center; gap: 12px; color: white; font-weight: 600; z-index: 3000; transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #notif.show { top: 30px; }

        /* Riwayat & Neraca */
        .item-riwayat-elite { background: linear-gradient(135deg, rgba(255,255,255,0.07), rgba(255,255,255,0.02)); backdrop-filter: blur(10px); border: 1px solid var(--kaca-garis); border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
        .kartu-neraca { background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02)); backdrop-filter: blur(15px); border: 1px solid var(--kaca-garis); border-radius: 25px; padding: 25px; margin-bottom: 10px; }
        .neraca-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .neraca-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; }

        /* Export Bar */
        .box-export { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 30px; }
        .btn-export { background: rgba(239, 191, 59, 0.05); border: 1px solid rgba(239, 191, 59, 0.3); color: var(--emas-murni); padding: 10px; border-radius: 12px; cursor: pointer; font-size: 0.65rem; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; transition: 0.3s; }
        .btn-export:active { background: var(--emas-murni); color: var(--biru-dalam); }

        /* Input & Nav */
        input, select, textarea { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--kaca-garis); color: #fff; padding: 14px; border-radius: 15px; font-family: 'Poppins'; margin-bottom: 12px; outline: none; box-sizing: border-box; }
        .label-input { font-size: 0.65rem; color: var(--emas-murni); margin-bottom: 5px; display: block; text-align: left; }
        .nav-bawah { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); display: flex; justify-content: space-around; padding: 12px; border-radius: 20px; border: 1px solid var(--kaca-garis); z-index: 1000; }
        .nav-item { color: rgba(255,255,255,0.4); display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.aktif { color: var(--emas-murni); }
        .nav-item span { font-size: 0.6rem; font-weight: 600; text-transform: uppercase; }

        #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.92); backdrop-filter: blur(15px); z-index: 2000; justify-content: center; align-items: center; padding: 20px; }
        .modal-konten { background: linear-gradient(160deg, #0f172a 0%, #040a16 100%); border: 1px solid var(--kaca-garis); border-radius: 30px; padding: 30px; width: 100%; max-width: 380px; text-align: center; }

        @keyframes geserAtas { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="notif"><i class="fa-solid fa-circle-check" style="color:var(--sukses)"></i><span>Data Tersimpan</span></div>

    <div class="wadah">
        <div id="beranda" class="halaman aktif">
            <header>
                <div class="logo-crown"><i class="fa-solid fa-crown"></i></div>
                <h1>MACCA FLOW</h1>
                <span class="sub-header">Elite Financial System</span>
            </header>
            
            <div class="kartu-saldo">
                <small style="color:var(--emas-murni); letter-spacing: 2px;">SALDO TERSEDIA</small>
                <div class="jumlah-saldo" id="saldoUtama">Rp. 0</div>
            </div>

            <div class="kartu-grafik">
                <canvas id="chartTrend" style="max-height: 180px;"></canvas>
                <div class="chart-legend">
                    <div class="legend-item"><span class="dot" style="background:#00ff88"></span> In</div>
                    <div class="legend-item"><span class="dot" style="background:#ff3366"></span> Out</div>
                    <div class="legend-item"><span class="dot" style="background:#3399ff"></span> Gerai</div>
                    <div class="legend-item"><span class="dot" style="background:#efbf3b"></span> Warkop</div>
                    <div class="legend-item"><span class="dot" style="background:#8a2be2"></span> Kasir</div>
                </div>
            </div>
            
            <h2><i class="fa-solid fa-arrow-down-long" style="color:var(--sukses)"></i> Kas Masuk</h2>
            <div class="grid-tombol">
                <button class="tombol-aksi" onclick="bukaModal('CASH KASIR', 'masuk')"><i class="fa-solid fa-cash-register"></i><span>Kasir</span></button>
                <button class="tombol-aksi" onclick="bukaModal('CASH GERAI', 'masuk')"><i class="fa-solid fa-store"></i><span>Gerai</span></button>
                <button class="tombol-aksi" onclick="bukaModal('CASH WARKOP', 'masuk')"><i class="fa-solid fa-mug-hot"></i><span>Warkop</span></button>
                <button class="tombol-aksi" onclick="bukaModal('TRANSFER / QRIS', 'masuk')"><i class="fa-solid fa-qrcode"></i><span>QRIS</span></button>
            </div>

            <h2><i class="fa-solid fa-arrow-up-long" style="color:var(--bahaya)"></i> Kas Keluar</h2>
            <div class="grid-tombol">
                <button class="tombol-aksi" onclick="bukaModal('KASIR (ARA)', 'keluar')"><i class="fa-solid fa-user-tie"></i><span>Kasir</span></button>
                <button class="tombol-aksi" onclick="bukaModal('DAPUR (IBU ATI)', 'keluar')"><i class="fa-solid fa-kitchen-set"></i><span>Dapur</span></button>
                <button class="tombol-aksi" onclick="bukaModal('STOK IKAN/GAS (HASBI)', 'keluar')"><i class="fa-solid fa-fish"></i><span>Stok</span></button>
                <button class="tombol-aksi" onclick="bukaModal('PAK BOSS', 'keluar')"><i class="fa-solid fa-crown"></i><span>Boss</span></button>
            </div>
        </div>

        <div id="riwayat" class="halaman">
            <header>
                <div class="logo-crown"><i class="fa-solid fa-receipt"></i></div>
                <h1>RIWAYAT</h1>
                <span class="sub-header">Daily Transaction Logs</span>
            </header>
            <label class="label-input">PILIH TANGGAL</label>
            <input type="date" id="riwayatTgl" onchange="syncUI()">
            <div id="listRiwayat"></div>
        </div>

        <div id="neraca" class="halaman">
            <header>
                <div class="logo-crown"><i class="fa-solid fa-scale-balanced"></i></div>
                <h1>NERACA</h1>
                <span class="sub-header">Financial Report</span>
            </header>
            
            <label class="label-input">FILTER HARIAN</label>
            <input type="date" id="nDaily" onchange="syncUI()">
            <div id="boxHarian" class="kartu-neraca"></div>
            <div class="box-export">
                <button class="btn-export" onclick="universalExport('harian', 'pdf')"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                <button class="btn-export" onclick="universalExport('harian', 'excel')"><i class="fa-solid fa-file-excel"></i> EXCEL</button>
            </div>
            
            <label class="label-input">FILTER BULANAN</label>
            <input type="month" id="nMonthly" onchange="syncUI()">
            <div id="boxBulanan" class="kartu-neraca"></div>
            <div class="box-export">
                <button class="btn-export" onclick="universalExport('bulanan', 'pdf')"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                <button class="btn-export" onclick="universalExport('bulanan', 'excel')"><i class="fa-solid fa-file-excel"></i> EXCEL</button>
            </div>
            
            <label class="label-input">FILTER TAHUNAN</label>
            <select id="nYearly" onchange="syncUI()">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
            </select>
            <div id="boxTahunan" class="kartu-neraca"></div>
            <div class="box-export">
                <button class="btn-export" onclick="universalExport('tahunan', 'pdf')"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                <button class="btn-export" onclick="universalExport('tahunan', 'excel')"><i class="fa-solid fa-file-excel"></i> EXCEL</button>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-konten">
            <div id="labelStatus" class="label-status-modal">KAS MASUK</div>
            <h3 id="judulModal" style="color:white; margin:0 0 15px;">KATEGORI</h3>
            <div id="boxSubDynamic" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:20px;"></div>
            <div id="boxSubLevel2" style="display:none; flex-wrap:wrap; gap:8px; margin-bottom:20px;"></div>
            <label class="label-input">TANGGAL</label>
            <input type="date" id="inTanggal">
            <label class="label-input">NOMINAL</label>
            <input type="text" id="inNominal" placeholder="Rp. 0" oninput="formatRupiah(this)">
            <label class="label-input">CATATAN</label>
            <textarea id="inCatatan" rows="2" placeholder="Keterangan..."></textarea>
            <button onclick="simpanData()" style="width:100%; padding:15px; background:linear-gradient(45deg, var(--ungu-elektrik), var(--pink-krimson)); border:none; border-radius:15px; color:white; font-weight:600; cursor:pointer">SIMPAN DATA</button>
            <p onclick="tutupModal()" style="text-align:center; color:rgba(255,255,255,0.3); cursor:pointer; margin-top:15px;">BATALKAN</p>
        </div>
    </div>

    <nav class="nav-bawah">
        <div class="nav-item aktif" onclick="gantiHal('beranda')"><i class="fa-solid fa-house"></i><span>Beranda</span></div>
        <div class="nav-item" onclick="gantiHal('riwayat')"><i class="fa-solid fa-receipt"></i><span>Riwayat</span></div>
        <div class="nav-item" onclick="gantiHal('neraca')"><i class="fa-solid fa-scale-balanced"></i><span>Neraca</span></div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, Timestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAXs5ZVr6gop28qPKbeaqTRiNdEGZlZMZQ", authDomain: "cashflowmacca.firebaseapp.com", projectId: "cashflowmacca" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const colRef = collection(db, "transactions");

        let cache = [], lineChart = null;
        const getHariIni = () => new Date().toLocaleDateString('en-CA');

        const configSub = {
            'CASH KASIR': ['Penjualan Toko', 'GrabFood', 'GoFood'],
            'TRANSFER / QRIS': ['QRIS', 'Transfer Bank'],
            'KASIR (ARA)': ['Operasional', 'Kasbon', 'Belanja'],
            'DAPUR (IBU ATI)': ['Bahan Dapur', 'Sayuran'],
            'STOK IKAN/GAS (HASBI)': ['Ikan', 'Gas'],
            'PAK BOSS': ['Offline', 'Online']
        };

        window.tampilkanNotif = () => {
            const n = document.getElementById('notif');
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        };

        // --- UNIVERSAL EXPORT LOGIC ---
        window.universalExport = (scope, type) => {
            let dataFilter = [];
            let fileName = "Laporan_Macca";
            const today = getHariIni();

            if (scope === 'harian') {
                const val = document.getElementById('nDaily').value || today;
                dataFilter = cache.filter(d => d.t.toLocaleDateString('en-CA') === val);
                fileName = `Harian_${val}`;
            } else if (scope === 'bulanan') {
                const val = document.getElementById('nMonthly').value || today.substring(0, 7);
                dataFilter = cache.filter(d => d.t.toLocaleDateString('en-CA').startsWith(val));
                fileName = `Bulanan_${val}`;
            } else {
                const val = document.getElementById('nYearly').value;
                dataFilter = cache.filter(d => d.t.getFullYear().toString() === val);
                fileName = `Tahunan_${val}`;
            }

            if (dataFilter.length === 0) return alert("Tidak ada data untuk periode ini!");

            if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text(`LAPORAN ${scope.toUpperCase()} MACCA FLOW`, 14, 15);
                const rows = dataFilter.map(d => [d.t.toLocaleDateString(), d.category, d.type==='in'?'In':'Out', d.amount.toLocaleString(), d.description]);
                doc.autoTable({ head: [['Tanggal', 'Kategori', 'Tipe', 'Nominal', 'Catatan']], body: rows, startY: 25 });
                doc.save(`Macca_${fileName}.pdf`);
            } else {
                const rows = dataFilter.map(d => ({
                    'Tanggal': d.t.toLocaleDateString(),
                    'Kategori': d.category,
                    'Tipe': d.type === 'in' ? 'MASUK' : 'KELUAR',
                    'Nominal': d.amount,
                    'Keterangan': d.description
                }));
                const ws = XLSX.utils.json_to_sheet(rows);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                ws['!cols'] = [{wch:15}, {wch:20}, {wch:12}, {wch:15}, {wch:40}];
                XLSX.writeFile(wb, `Macca_${fileName}.xlsx`);
            }
        };

        const initLineChart = () => {
            const ctx = document.getElementById('chartTrend').getContext('2d');
            lineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'In', borderColor: '#00ff88', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 },
                        { label: 'Out', borderColor: '#ff3366', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0 },
                        { label: 'Gerai', borderColor: '#3399ff', data: [], tension: 0.4, borderWidth: 1, borderDash:[4,4], pointRadius: 0 },
                        { label: 'Warkop', borderColor: '#efbf3b', data: [], tension: 0.4, borderWidth: 1, borderDash:[4,4], pointRadius: 0 },
                        { label: 'Kasir', borderColor: '#8a2be2', data: [], tension: 0.4, borderWidth: 1, borderDash:[4,4], pointRadius: 0 }
                    ]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { color: 'rgba(255,255,255,0.3)', font: { size: 9 } } } } }
            });
        };

        const updateLineChart = () => {
            if(!lineChart) return;
            const labels = [], dIn = [], dOut = [], dG = [], dW = [], dK = [];
            for(let i=6; i>=0; i--) {
                const t = new Date(); t.setDate(t.getDate() - i);
                const s = t.toLocaleDateString('en-CA');
                labels.push(t.toLocaleDateString('id-ID', { weekday: 'short' }));
                let inT=0, outT=0, gT=0, wT=0, kT=0;
                cache.filter(x => x.t.toLocaleDateString('en-CA') === s).forEach(x => {
                    if(x.type === 'in') {
                        inT += x.amount;
                        if(x.category === 'CASH GERAI') gT += x.amount;
                        if(x.category === 'CASH WARKOP') wT += x.amount;
                        if(x.category === 'CASH KASIR') kT += x.amount;
                    } else outT += x.amount;
                });
                dIn.push(inT); dOut.push(outT); dG.push(gT); dW.push(wT); dK.push(kT);
            }
            lineChart.data.labels = labels;
            lineChart.data.datasets[0].data = dIn;
            lineChart.data.datasets[1].data = dOut;
            lineChart.data.datasets[2].data = dG;
            lineChart.data.datasets[3].data = dW;
            lineChart.data.datasets[4].data = dK;
            lineChart.update();
        };

        window.formatRupiah = (el) => {
            let v = el.value.replace(/\D/g, "");
            el.value = v ? "Rp. " + parseInt(v).toLocaleString('id-ID') : "";
        };

        window.bukaModal = (k, t) => {
            window.cKat = k; window.cTip = t; window.cSub = ""; window.cSub2 = "";
            document.getElementById('inNominal').value = ""; document.getElementById('inCatatan').value = "";
            document.getElementById('judulModal').innerText = k;
            document.getElementById('inTanggal').value = getHariIni();
            const label = document.getElementById('labelStatus');
            if(t === 'masuk') { label.innerText = "KAS MASUK"; label.className = "label-status-modal status-hijau"; }
            else { label.innerText = "KAS KELUAR"; label.className = "label-status-modal status-merah"; }
            const subBox = document.getElementById('boxSubDynamic');
            const subBox2 = document.getElementById('boxSubLevel2');
            subBox.innerHTML = ""; subBox2.innerHTML = ""; subBox2.style.display = 'none';
            if(configSub[k]) {
                configSub[k].forEach((s, idx) => {
                    const btn = document.createElement('button');
                    btn.innerText = s;
                    btn.style.cssText = "flex:1; min-width:80px; padding:10px; border-radius:12px; border:1px solid var(--kaca-garis); background:transparent; color:white; font-size:0.7rem; cursor:pointer;";
                    if(idx===0) { window.cSub = s; logicLevel2(k, s); btn.style.backgroundColor = 'var(--emas-murni)'; btn.style.color = 'var(--biru-dalam)'; }
                    btn.onclick = () => {
                        Array.from(subBox.children).forEach(b => { b.style.backgroundColor = 'transparent'; b.style.color = 'white'; });
                        btn.style.backgroundColor = 'var(--emas-murni)'; btn.style.color = 'var(--biru-dalam)';
                        window.cSub = s; logicLevel2(k, s);
                    };
                    subBox.appendChild(btn);
                });
            }
            document.getElementById('modal').style.display = 'flex';
        };

        const logicLevel2 = (k, s) => {
            const subBox2 = document.getElementById('boxSubLevel2');
            if ((k === 'PAK BOSS' && s === 'Online') || (k === 'TRANSFER / QRIS' && s === 'Transfer Bank')) {
                subBox2.innerHTML = ""; subBox2.style.display = 'flex';
                ['TF BRI', 'TF BNI'].forEach((bank, idx) => {
                    const btn = document.createElement('button');
                    btn.innerText = bank;
                    btn.style.cssText = "flex:1; min-width:80px; padding:10px; border-radius:12px; border:1px solid var(--kaca-garis); background:transparent; color:white; font-size:0.7rem; cursor:pointer;";
                    if(idx===0) { window.cSub2 = bank; btn.style.backgroundColor = 'var(--emas-murni)'; btn.style.color = 'var(--biru-dalam)'; }
                    btn.onclick = () => {
                        Array.from(subBox2.children).forEach(b => { b.style.backgroundColor = 'transparent'; b.style.color = 'white'; });
                        btn.style.backgroundColor = 'var(--emas-murni)'; btn.style.color = 'var(--biru-dalam)';
                        window.cSub2 = bank;
                    };
                    subBox2.appendChild(btn);
                });
            } else { subBox2.style.display = 'none'; window.cSub2 = ""; }
        };

        window.tutupModal = () => { document.getElementById('modal').style.display = 'none'; };

        window.simpanData = async () => {
            const nom = parseInt(document.getElementById('inNominal').value.replace(/\D/g, ""));
            const tgl = document.getElementById('inTanggal').value;
            if(!nom || !tgl) return alert("Isi nominal!");
            const desc = (window.cSub ? `[${window.cSub}] ` : "") + (window.cSub2 ? `[${window.cSub2}] ` : "") + document.getElementById('inCatatan').value;
            await addDoc(colRef, {
                category: window.cKat, type: window.cTip === 'masuk' ? 'in' : 'out', amount: nom, description: desc,
                timestamp: Timestamp.fromDate(new Date(tgl + "T" + new Date().toLocaleTimeString('en-GB')))
            });
            tutupModal();
            tampilkanNotif();
        };

        window.gantiHal = (id) => {
            document.querySelectorAll('.halaman').forEach(h => h.classList.remove('aktif'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('aktif'));
            document.getElementById(id).classList.add('aktif');
            event.currentTarget.classList.add('aktif');
            syncUI();
        };

        onSnapshot(query(colRef, orderBy("timestamp", "desc")), (s) => {
            cache = []; let sal = 0;
            s.forEach(d => { const x = d.data(); cache.push({...x, id: d.id, t: x.timestamp.toDate()}); });
            cache.forEach(i => sal += (i.type === 'in' ? i.amount : -i.amount));
            document.getElementById('saldoUtama').innerText = "Rp. " + sal.toLocaleString('id-ID');
            syncUI();
        });

        window.syncUI = () => {
            updateLineChart();
            const list = document.getElementById('listRiwayat'); if(list) {
                list.innerHTML = "";
                const filter = document.getElementById('riwayatTgl').value || getHariIni();
                cache.filter(d => d.t.toLocaleDateString('en-CA') === filter).forEach(d => {
                    const isIn = d.type === 'in';
                    const div = document.createElement('div'); div.className = 'item-riwayat-elite';
                    div.innerHTML = `
                        <div class="riwayat-kiri"><div class="riwayat-icon-box" style="background:rgba(${isIn?'0,255,136':'255,51,102'},0.1); color:var(${isIn?'--sukses':'--bahaya'})"><i class="fa-solid fa-arrow-${isIn?'down':'up'}"></i></div><div class="riwayat-info"><span style="font-weight:600; font-size:0.85rem;">${d.category}</span><small style="opacity:0.4; font-size:0.6rem;">${d.t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</small></div></div>
                        <div class="riwayat-kanan"><span class="riwayat-amt" style="color:${isIn?'#00ff88':'#ff3366'}">${isIn?'+':'-'} Rp ${d.amount.toLocaleString()}</span><small style="opacity:0.3; font-size:0.55rem;">${d.description || ''}</small></div>`;
                    list.appendChild(div);
                });
            }
            drawNeracaMewah("boxHarian", cache.filter(d => d.t.toLocaleDateString('en-CA') === (document.getElementById('nDaily').value || getHariIni())), "RINGKASAN HARIAN");
            drawNeracaMewah("boxBulanan", cache.filter(d => d.t.toLocaleDateString('en-CA').substring(0, 7) === (document.getElementById('nMonthly').value || getHariIni().substring(0, 7))), "RINGKASAN BULANAN");
            drawNeracaMewah("boxTahunan", cache.filter(d => d.t.getFullYear().toString() === document.getElementById('nYearly').value), "RINGKASAN TAHUNAN");
        };

        const drawNeracaMewah = (target, data, title) => {
            let pIn = 0, pOut = 0; data.forEach(d => { if(d.type==='in') pIn += d.amount; else pOut += d.amount; });
            const el = document.getElementById(target); if(!el) return;
            el.innerHTML = `
                <span style="font-size:0.6rem; color:var(--emas-murni); letter-spacing:2px; display:block; margin-bottom:15px; text-transform:uppercase;">${title}</span>
                <div class="neraca-row"><div class="neraca-icon" style="background:rgba(0,255,136,0.1); color:var(--sukses)"><i class="fa-solid fa-arrow-down"></i></div><div><small style="opacity:0.4; font-size:0.6rem">Masuk</small><div style="font-weight:600">Rp ${pIn.toLocaleString()}</div></div></div>
                <div class="neraca-row"><div class="neraca-icon" style="background:rgba(255,51,102,0.1); color:var(--bahaya)"><i class="fa-solid fa-arrow-up"></i></div><div><small style="opacity:0.4; font-size:0.6rem">Keluar</small><div style="font-weight:600">Rp ${pOut.toLocaleString()}</div></div></div>
                <div style="margin-top:10px; padding-top:10px; border-top:1px solid var(--kaca-garis)"><div class="neraca-row" style="margin-bottom:0"><div class="neraca-icon" style="background:rgba(239,191,59,0.1); color:var(--emas-murni)"><i class="fa-solid fa-scale-balanced"></i></div><div><small style="opacity:0.4; font-size:0.6rem">Laba Bersih</small><div style="color:var(--emas-murni); font-weight:600">Rp ${(pIn-pOut).toLocaleString()}</div></div></div></div>`;
        };

        window.onload = () => {
            initLineChart();
            document.getElementById('riwayatTgl').value = getHariIni();
            document.getElementById('nDaily').value = getHariIni();
            document.getElementById('nMonthly').value = getHariIni().substring(0, 7);
        };
    </script>
</body>
</html>
